<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <title>GPT Security Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function escapeHTML(str) {
            if (typeof str !== "string") return '';
            return str.replace(/[&<>"']/g, function (m) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[m];
            });
        }

        async function generateAttacks(sessionId) {
            try {
                const res = await fetch("/generate_attacks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId: sessionId })
                });

                if (!res.ok) {
                    console.error("‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É:", res.status);
                    alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∞—Ç–∞–∫.");
                    return;
                }

                const data = await res.json();
                console.log("‚úÖ –û—Ç—Ä–∏–º–∞–Ω—ñ –∞—Ç–∞–∫–∏:", data);

                const container = document.querySelector(`#attacks-${sessionId}`);
                if (!container) {
                    console.error("‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è sessionId:", sessionId);
                    return;
                }

                container.innerHTML = '';

                if (data.attacks && data.attacks.length > 0) {
                    const details = document.createElement("details");
                    details.open = true;

                    const summary = document.createElement("summary");
                    summary.innerText = "üéØ –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –∞—Ç–∞–∫–∏";
                    details.appendChild(summary);

                    const ul = document.createElement("ul");
                    data.attacks.forEach(attack => {
                        const —Ç–∏–ø–ê—Ç–∞–∫–∏ = escapeHTML(attack["—Ç–∏–ø–ê—Ç–∞–∫–∏"] || '');
                        const –ø–∞—Ä–∞–º–µ—Ç—Ä = escapeHTML(attack["–ø–æ–ª–µ"] || attack["–ø–∞—Ä–∞–º–µ—Ç—Ä"] || '');
                        const payload = escapeHTML(attack["payload"] || '');
                        const –ø–æ—è—Å–Ω–µ–Ω–Ω—è = escapeHTML(attack["–ø–æ—è—Å–Ω–µ–Ω–Ω—è"] || '');

                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>–¢–∏–ø –∞—Ç–∞–∫–∏:</strong> ${—Ç–∏–ø–ê—Ç–∞–∫–∏}<br>
                            <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä:</strong> <code>${–ø–∞—Ä–∞–º–µ—Ç—Ä}</code><br>
                            <strong>Payload:</strong> <code>${payload}</code><br>
                            <strong>–ü–æ—è—Å–Ω–µ–Ω–Ω—è:</strong> ${–ø–æ—è—Å–Ω–µ–Ω–Ω—è}
                        `;
                        ul.appendChild(li);
                    });

                    details.appendChild(ul);
                    container.appendChild(details);
                } else {
                    container.innerHTML = "<i>–ù–µ–º–∞—î –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –∞—Ç–∞–∫.</i>";
                }
            } catch (err) {
                console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É:", err);
            }
        }

        function renderVulnerabilities(sessionId, vulns) {
            const container = document.querySelector(`#vulns-${sessionId}`);
            if (!container || !vulns || !vulns.length) return;

            const details = document.createElement("details");
            details.open = true;

            const summary = document.createElement("summary");
            summary.innerText = "üõ°Ô∏è –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ";
            details.appendChild(summary);

            const ul = document.createElement("ul");
            vulns.forEach(vuln => {
                const —Ç–∏–ø–ê—Ç–∞–∫–∏ = escapeHTML(vuln["—Ç–∏–ø–ê—Ç–∞–∫–∏"] || '');
                const –ø–∞—Ä–∞–º–µ—Ç—Ä = escapeHTML(vuln["–ø–∞—Ä–∞–º–µ—Ç—Ä"] || vuln["–ø–æ–ª–µ"] || '');
                const payload = escapeHTML(vuln["payload"] || '');
                const –ø–æ—è—Å–Ω–µ–Ω–Ω—è = escapeHTML(vuln["–ø–æ—è—Å–Ω–µ–Ω–Ω—è"] || '');

                const li = document.createElement("li");
                li.innerHTML = `
                    <strong>–¢–∏–ø –∞—Ç–∞–∫–∏:</strong> ${—Ç–∏–ø–ê—Ç–∞–∫–∏}<br>
                    <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä:</strong> <code>${–ø–∞—Ä–∞–º–µ—Ç—Ä}</code><br>
                    <strong>Payload:</strong> <code>${payload}</code><br>
                    <strong>–ü–æ—è—Å–Ω–µ–Ω–Ω—è:</strong> ${–ø–æ—è—Å–Ω–µ–Ω–Ω—è}
                `;
                ul.appendChild(li);
            });

            details.appendChild(ul);
            container.appendChild(details);
        }

        function saveAsFile(sessionId) {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], { type: "text/html;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = sessionId + "_full_report.html";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</head>
<body>
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑—É HTTP-–∑–∞–ø–∏—Ç—ñ–≤ —ñ–∑ ChatGPT</h1>

    {% if data %}
        {% for session_id, item in data.items() %}
        <div class="card">
            <h3>–°–µ—Å—ñ—è: {{ session_id }}</h3>

            <strong>–ó–∞–ø–∏—Ç:</strong>
            <pre class="monospace">{{ item.input | e }}</pre>

            <strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:</strong> {{ item.output["–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—èEndpoint"] }}<br>
            <strong>–ú–µ—Ö–∞–Ω—ñ–∑–º –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:</strong> {{ item.output["–º–µ—Ö–∞–Ω—ñ–∑–º–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó"] }}<br>

            <div id="vulns-{{ session_id }}"></div>
            <div class="comment-block">{{ item.output["–∫–æ–º–µ–Ω—Ç–∞—Ä"] }}</div>

            <div id="attacks-{{ session_id }}"></div>

		<div class="button-group">
		    <button onclick="generateAttacks('{{ session_id }}')">‚öîÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–µ–π–ª–æ—É–¥–∏</button>
		    <button onclick='saveAsFile("{{ session_id }}")'>üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é</button>
		    <button onclick='clearOutput("{{ session_id }}")'>üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
		</div>

            {% if "–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ–í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ" in item.output and item.output["–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ–í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ"] %}
            <script>
                renderVulnerabilities("{{ session_id }}", {{ item.output["–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ–í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ"] | tojson | safe }});
            </script>
            {% else %}
            <script>
                console.warn("‚ö†Ô∏è –í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –≤–æ–Ω–∏ –ø–æ—Ä–æ–∂–Ω—ñ.");
            </script>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <p>‚è≥ –û—á—ñ–∫—É—î–º–æ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É...</p>
    {% endif %}

    <script>
        let prevSessionCount = {{ data|length }};
        setInterval(() => {
            fetch("/")
                .then(res => res.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const newCards = doc.querySelectorAll(".card");
                    if (newCards.length > prevSessionCount) {
                        location.reload();
                    }
                });
        }, 3000);
    </script>
<script>
    function clearOutput(sessionId) {
        fetch("/clear_session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId: sessionId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                console.log(`üßπ –°–µ—Ä–≤–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –æ—á–∏—â–µ–Ω–Ω—è —Å–µ—Å—ñ—ó: ${sessionId}`);
                // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –ª–∏—à–µ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
                location.reload();
            } else {
                alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—á–∏—Å—Ç–∏—Ç–∏ —Å–µ—Å—ñ—é: " + data.message);
            }
        })
        .catch(err => {
            console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ –Ω–∞ –æ—á–∏—â–µ–Ω–Ω—è:", err);
        });
    }
</script>

    <footer style="margin-top: 50px; text-align: center; font-size: 0.9em; color: #777;">
        üîß –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ <strong>üßë‚Äçüíª <a href="https://www.linkedin.com/in/zavada-nazarii" target="_blank" style="color: #555; text-decoration: none;">Nazarii Zavada</a></strong>, 2025
    </footer>
</body>
</html>
